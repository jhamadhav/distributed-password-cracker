<!doctype html>
<meta charset="utf-8">
<title>miniWebRTC | join</title>

<h3>Join a room?</h3>
<hr>

<h3>Paste the "offer" you received</h3>
<input id="remoteOffer" rows=10 cols=50>
<br>
<br>
<button id="offerRecdBtn">Okay, I pasted it.</button>
<h3>Then, send your local answer to main</h3>
<input id="localAnswer" rows=10 cols=50>
<hr>
Chat:
<br>
<div id="chatlog" style="height:200px; overflow:auto; border:1px solid"></div>
<br>
<input type="text" id="messageTextBox" placeholder="Type your message here">
<button id="sendMessageBtn" onclick="sendMessage()">Send message</button>

<script>
    remoteOffer.value = localAnswer.value = "";

    if (navigator.webkitGetUserMedia) {
        RTCPeerConnection = webkitRTCPeerConnection
    }

    let cfg = { 'iceServers': [{ 'url': "stun:stun.gmx.net" }] }
    let con = { 'optional': [{ 'DtlsSrtpKeyAgreement': true }] }
    let sdpConstraints = { optional: [], }

    let pc2 = new RTCPeerConnection(cfg, con), dc2 = null, pc2icedone = false;

    // client: pasted main's answer
    offerRecdBtn.onclick = function () {

        console.log("offer received!!");

        let offerDesc = new RTCSessionDescription(JSON.parse(remoteOffer.value))
        pc2.setRemoteDescription(offerDesc)

        console.log("creating answer");
        pc2.createAnswer((answerDesc) => {
            pc2.setLocalDescription(answerDesc)
        }, () => { }, sdpConstraints)
    };

    pc2.ondatachannel = (e) => {
        let datachannel = e.channel || e;
        dc2 = datachannel

        dc2.onopen = (e) => { }
        dc2.onmessage = (e) => {
            if (e.data.size) {
                fileReceiver2.receive(e.data, {})
            } else {
                let data = JSON.parse(e.data)
                if (data.type === 'file') {
                    fileReceiver2.receive(e.data, {})
                } else {
                    chatlog.innerHTML += '[' + new Date() + '] ' + data.message + '</p>';
                    chatlog.scrollTop = chatlog.scrollHeight;
                }
            }
        }
    }

    pc2.onicecandidate = (e) => {
        if (e.candidate == null) {
            localAnswer.value = JSON.stringify(pc2.localDescription);
            console.log(localAnswer.value);
        }
    }

    sendMessage = () => {
        if (messageTextBox.value) {
            dc2.send(JSON.stringify({ message: messageTextBox.value }));
            chatlog.innerHTML += '[' + new Date() + '] ' + messageTextBox.value + '</p>';
            messageTextBox.value = "";
        }
        return false
    }
</script>