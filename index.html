<!doctype html>
<meta charset="utf-8">
<title>miniWebRTC | create</title>

<h3>Create a room?</h3>
<h3>To join a room open <a href="./client.html" target="_blank">client window</a> in another tab!!</h3>
<button id="createBtn">Create</button>
<hr>
<h3 id="myModalLabel">main: Send your local "offer" to others</h3>
<input id="localOffer" rows=10 cols=50>
<br>
<h3>Then, paste the "answer" you received</h3>
<input id="remoteAnswer" rows=10 cols=50>
<br>
<br>
<button id="answerRecdBtn">Okay, I pasted it.</button>
<hr>
Chat:
<br>
<div id="chatlog" style="height:200px; overflow:auto; border:1px solid"></div>
<br>
<input type="text" id="messageTextBox" placeholder="Type your message here">
<button id="sendMessageBtn" onclick="sendMessage()">Send message</button>

<script>
    localOffer.value = remoteAnswer.value = "";

    // create
    createBtn.onclick = function () {
        dc1 = pc1.createDataChannel('test', { reliable: true })
        activedc = dc1
        dc1.onopen = function (e) { }
        dc1.onmessage = function (e) {
            if (e.data.size) {
                fileReceiver1.receive(e.data, {})
            } else {
                if (e.data.charCodeAt(0) == 2) {
                    return
                }
                var data = JSON.parse(e.data)
                if (data.type === 'file') {
                    fileReceiver1.receive(e.data, {})
                } else {
                    chatlog.innerHTML += '[' + new Date() + '] ' + data.message + '</p>';
                    chatlog.scrollTop = chatlog.scrollHeight
                }
            }
        }

        console.log("main: creating offer");
        pc1.createOffer((desc) => {
            console.log("main's offer");
            console.log(desc);

            pc1.setLocalDescription(desc, () => { }, () => { })

        }, () => { }, sdpConstraints)
    };

    // main: pasted other's answer
    answerRecdBtn.onclick = function () {
        var answer = remoteAnswer.value;
        console.log("answer received!");
        var answerDesc = new RTCSessionDescription(JSON.parse(answer))
        pc1.setRemoteDescription(answerDesc);
        console.log("you can start chatting!!");
    };

    if (navigator.webkitGetUserMedia) {
        RTCPeerConnection = webkitRTCPeerConnection
    }

    let cfg = { 'iceServers': [{ 'url': "stun:stun.gmx.net" }] }
    let con = { 'optional': [{ 'DtlsSrtpKeyAgreement': true }] }

    let pc1 = new RTCPeerConnection(cfg, con), dc1 = null, tn1 = null, activedc, pc1icedone = false;

    var sdpConstraints = {
        optional: [],
    }

    function sendMessage() {
        if (messageTextBox.value) {
            activedc.send(JSON.stringify({ message: messageTextBox.value }));
            chatlog.innerHTML += '[' + new Date() + '] ' + messageTextBox.value + '</p>';
            messageTextBox.value = "";
        }
        return false
    }

    pc1.onicecandidate = function (e) {
        if (e.candidate == null) {
            localOffer.value = JSON.stringify(pc1.localDescription);
        }
    }
</script>